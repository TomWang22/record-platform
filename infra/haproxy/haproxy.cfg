global
  log stdout format raw local0
  maxconn 5000
  tune.bufsize 32768

defaults
  mode http
  log global
  option httplog
  option http-keep-alive
  timeout connect 5s
  timeout client  60s
  timeout server  60s
  retries 3

# Docker DNS so HAProxy can learn scaled api-gateway IPs
resolvers docker
  nameserver dns 127.0.0.11:53
  hold valid 10s

frontend fe_api
  bind *:8081
  http-request set-header X-Forwarded-Proto https if { ssl_fc }
  http-request set-header X-Forwarded-Proto http  if !{ ssl_fc }
  http-request set-header X-Forwarded-Host   %[req.hdr(Host)]
  default_backend be_api

backend be_api
  balance leastconn
  http-reuse always
  option httpchk GET /healthz
  http-check expect status 200
  default-server inter 2s fall 2 rise 1 slowstart 2s maxconn 150 check resolvers docker resolve-prefer ipv4 init-addr libc,none
  # Auto-discover up to 10 api-gateway tasks on port 4000 via Docker DNS
  server-template api 10 api-gateway:4000 check resolvers docker resolve-prefer ipv4

# Stats UI + CSV on :8404 at "/"
listen stats
  bind *:8404
  mode http
  stats enable
  stats uri /
  stats refresh 2s

