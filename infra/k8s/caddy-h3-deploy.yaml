# FILE: k8s/caddy-h3-deploy.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: caddy-h3
  namespace: ingress-nginx
spec:
  strategy: { type: Recreate }
  replicas: 1
  selector: { matchLabels: { app: caddy-h3 } }
  template:
    metadata: { labels: { app: caddy-h3 } }
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      terminationGracePeriodSeconds: 5
      containers:
      - name: caddy
        image: caddy:2.8
        # root needed to bind 443; only CAP_NET_BIND_SERVICE elevated
        securityContext:
          runAsNonRoot: false
          capabilities: { add: ["NET_BIND_SERVICE"] }
        ports:
        - { name: https, containerPort: 443, protocol: TCP }
        - { name: https-udp, containerPort: 443, protocol: UDP }
        volumeMounts:
        - { name: caddy-conf,  mountPath: /etc/caddy }                       # Caddyfile
        - { name: caddy-certs, mountPath: /etc/caddy/certs, readOnly: true } # tls.crt,tls.key
        - { name: caddy-ca,    mountPath: /etc/caddy/ca,    readOnly: true } # dev-root.pem
        readinessProbe:
          httpGet:
            scheme: HTTPS
            path: /_caddy/healthz
            port: 443
          periodSeconds: 5
          failureThreshold: 6
        livenessProbe:
          tcpSocket: { port: 443 }
          initialDelaySeconds: 3
          periodSeconds: 10
          failureThreshold: 3
      volumes:
      - name: caddy-conf
        configMap:
          name: caddy-h3
          items: [{ key: Caddyfile, path: Caddyfile }]
      - name: caddy-certs
        secret:
          secretName: record-local-tls
          items:
            - { key: tls.crt, path: tls.crt }
            - { key: tls.key, path: tls.key }
      - name: caddy-ca
        secret:
          secretName: dev-root-ca
          items:
            - { key: dev-root.pem, path: dev-root.pem }